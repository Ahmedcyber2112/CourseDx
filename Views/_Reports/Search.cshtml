@using CourseDx.Models.Reports
@model CourseDx.Models.Reports.SearchViewModel

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Reports";
    ViewData["Controller"] = "Admin";
    ViewData["Action"] = "DeleteConfirmed";
}

<!-- Inject config into JS -->
<script>
    window.deleteConfig = {
        controller: '@ViewData["Controller"]',
        action: '@ViewData["Action"]'
    };
</script>

<div class="admin-table-container">
    <div class="admin-header">
        <h1 class="admin-title">Reports</h1>
    </div>

    <!-- Export Buttons Section -->
    @if (Model.Results != null && Model.Results.Any())
    {
        <div class="flex gap-4 mb-6">
            <form asp-action="ExportToPDF" method="post">
                <button type="submit" class="rounded-lg cursor-pointer bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    تحميل ملف PDF
                </button>
            </form>

            <form asp-action="ExportToExcel" method="post">
                <button type="submit" class="rounded-lg cursor-pointer bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                    تحميل ملف Excel
                </button>
            </form>
        </div>
    }

    <!-- Search Form Card -->
    <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white px-4 pb-3 pt-4  sm:px-6 mb-8">
        <form asp-action="Search" method="post">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Student Dropdown -->
                <div class="form-group">
                    <label asp-for="StudentIds" class="block text-sm font-medium text-gray-700  mb-1">Student ID</label>
                    <select id="studentId" asp-for="StudentIds" asp-items="@Model.Students"
                            class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                        <option value="">-- Select Student --</option>
                    </select>
                    <span asp-validation-for="StudentIds" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <!-- Instructor Dropdown -->
                <div class="form-group">
                    <label asp-for="InstructorIds" class="block text-sm font-medium text-gray-700  mb-1">Instructor ID</label>
                    <select id="InstructorId" asp-for="InstructorIds" asp-items="@Model.Instructors"
                            class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                        <option value="">-- Select Instructor --</option>
                    </select>
                    <span asp-validation-for="InstructorIds" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <!-- Course Dropdown -->
                <div class="form-group">
                    <label asp-for="CourseIds" class="block text-sm font-medium text-gray-700  mb-1">Course ID</label>
                    <select id="CourseId" asp-for="CourseIds" asp-items="@Model.Courses"
                            class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                        <option value="">-- Select Course --</option>
                    </select>
                    <span asp-validation-for="CourseIds" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <!-- Online Status Radio Buttons -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700  mb-1">Online Status</label>
                    <div class="flex gap-4">
                        <div class="flex items-center">
                            <input class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 "
                                   type="radio" asp-for="OnlineStatus" value="@OnlineStatus.Online" id="statusOnline">
                            <label class="ml-2 text-sm text-gray-700 " for="statusOnline">Online</label>
                        </div>
                        <div class="flex items-center">
                            <input class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500"
                                   type="radio" asp-for="OnlineStatus" value="@OnlineStatus.Offline" id="statusOffline">
                            <label class="ml-2 text-sm text-gray-700 " for="statusOffline">Offline</label>
                        </div>
                    </div>
                </div>

                <!-- Date Range -->
                <div class="form-group">
                    <label asp-for="StartDate" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="text" asp-for="StartDate"
                           class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm  flatpickr">
                    <span asp-validation-for="StartDate" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <div class="form-group">
                    <label asp-for="EndDate" class="block text-sm font-medium text-gray-700  mb-1">To Date</label>
                    <input type="text" asp-for="EndDate"
                           class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm  flatpickr">
                    <span asp-validation-for="EndDate" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <!-- Time Range -->
                <div class="form-group">
                    <label asp-for="StartTime" class="block text-sm font-medium text-gray-700 ">From Time</label>
                    <input type="time" asp-for="StartTime"
                           class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                    <span asp-validation-for="StartTime" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <div class="form-group">
                    <label asp-for="EndTime" class="block text-sm font-medium text-gray-700 mb-1">To Time</label>
                    <input type="time" asp-for="EndTime"
                           class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                    <span asp-validation-for="EndTime" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <!-- Price Range -->
                <div class="form-group">
                    <label asp-for="MinPrice" class="block text-sm font-medium text-gray-700  mb-1">Minimum Price</label>
                    <input type="number" asp-for="MinPrice" min="0" step="50"
                           class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                    <span asp-validation-for="MinPrice" class="mt-1 text-xs text-red-600 "></span>
                </div>

                <div class="form-group">
                    <label asp-for="MaxPrice" class="block text-sm font-medium text-gray-700 ">Maximum Price</label>
                    <input type="number" asp-for="MaxPrice" min="0" step="50"
                           class="w-full rounded-lg border-gray-200 p-2 text-sm shadow-sm ">
                    <span asp-validation-for="MaxPrice" class="mt-1 text-xs text-red-600 "></span>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <button type="submit"
                        class="w-full sm:w-auto rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Search
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section -->
    @if (Model.Results != null && Model.Results.Any())
    {
        <div class="admin-table-wrapper">
            <table class="table jDataTable">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Title</th>
                        <th>Instructor</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Price</th>
                        <th>Online</th>
                        <th>Paid</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Results)
                    {
                        <tr>
                            <td>@item.Course?.Name</td>
                            <td>@item.Title</td>
                            <td>@item.Instractor?.Name</td>
                            <td>@item.From_Date.ToShortDateString() - @item.To_Date.ToShortDateString()</td>
                            <td>@item.From_Time.ToString(@"hh\:mm") - @item.To_Time.ToString(@"hh\:mm")</td>
                            <td>@item.Price</td>
                            <td>@(item.IsOn_line ? "Yes" : "No")</td>
                            <td>@(item.IsPaid ? "Yes" : "No")</td>
                            <td>
                                <div class="action-buttons flex flex-wrap gap-2">
                                    <a asp-controller="CourseEnrollment" asp-action="Create" asp-route-id="@item.id"
                                       class="action-btn update-btn whitespace-nowrap">
                                        Assign to course
                                    </a>
                                    <a href="#"
                                       class="action-btn delete-btn whitespace-nowrap"
                                       data-id="1"
                                       data-name="DON'T Delete">
                                        Delete
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Cards for mobile view -->
            <div class="user-cards">
                @foreach (var item in Model.Results)
                {
                    <div class="card">
                        <div class="card-header">
                            <span class="card-label">Report</span>
                            <span class="card-value">@item.Title</span>
                        </div>
                        <div class="card-body">
                            <div class="card-item">
                                <span class="card-label">Course:</span>
                                <span class="card-value">@(item.Course?.Name ?? "N/A")</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Title:</span>
                                <span class="card-value">@item.Title</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Instructor:</span>
                                <span class="card-value">@(item.Instractor?.Name ?? "N/A")</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Date:</span>
                                <span class="card-value">@item.From_Date.ToShortDateString() - @item.To_Date.ToShortDateString()</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Time:</span>
                                <span class="card-value">@item.From_Time.ToString(@"hh\:mm") - @item.To_Time.ToString(@"hh\:mm")</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Price:</span>
                                <span class="card-value">@item.Price</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Online:</span>
                                <span class="card-value">@(item.IsOn_line ? "Yes" : "No")</span>
                            </div>
                            <div class="card-item">
                                <span class="card-label">Paid:</span>
                                <span class="card-value">@(item.IsPaid ? "Yes" : "No")</span>
                            </div>
                        </div>
                        <div class="card-actions flex items-center">
                            <a asp-controller="CourseEnrollment" asp-action="Create" asp-route-id="@item.id" class="card-btn card-btn-update">Assign to course</a>
                            <a href="#" class="card-btn delete-btn " data-id="1">Delete</a>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else if (Model.Results != null)
    {
        <div class="text-center py-8">
            <p class="text-gray-500 ">No results found.</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize all select2 dropdowns
            $('#studentId').select2({
                placeholder: "-- Select Student --",
                allowClear: true,
                width: '100%'
            });

            $('#InstructorId').select2({
                placeholder: "-- Select Instructor --",
                allowClear: true,
                width: '100%'
            });

            $('#CourseId').select2({
                placeholder: "-- Select Course --",
                allowClear: true,
                width: '100%'
            });

            // Initialize flatpickr pickers
            flatpickr("#StartDate", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });

            flatpickr("#EndDate", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });
        });
    </script>
}

@Html.Partial("DeleteComfirm")